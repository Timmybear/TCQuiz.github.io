<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Pixel Reveal - Masked Reveal Edition</title>
  <style>
    :root {
      --bg: #000000;
      --text: #ffffff;
      --primary: #4f46e5;
      --success: #059669;
      --border: #333333;
    }

    body {
      font-family: 'Inter', -apple-system, sans-serif;
      background-color: var(--bg);
      color: var(--text);
      margin: 0;
      display: flex;
      align-items: center;
      justify-content: center;
      height: 100vh;
      overflow: hidden;
    }

    .screen {
      display: none;
      flex-direction: column;
      align-items: center;
      width: 90%;
      max-width: 900px;
      text-align: center;
    }

    #setup-area {
      display: flex;
      border: 1px solid var(--border);
      padding: 40px;
      border-radius: 20px;
      background: #080808;
      flex-direction: column;
      align-items: center;
    }

    input[type="text"], input[type="file"], select {
      background: #111;
      border: 1px solid var(--border);
      color: white;
      padding: 12px;
      margin: 10px 0;
      border-radius: 8px;
      width: 80%;
    }

    .hint {
      width: 80%;
      margin: 0 0 10px 0;
      font-size: 0.95rem;
      color: #cfcfcf;
      text-align: left;
    }

    .instruction-container { text-align: center; margin: 25px 0; }
    .instruction-list {
      text-align: left;
      display: inline-block;
      margin: 25px 0;
      font-size: 1.2rem;
      line-height: 1.8;
    }
    b { color: var(--text); font-weight: 800; }

    #answerDisplay {
      font-size: 2.5rem;
      font-weight: 900;
      margin-bottom: 10px;
      height: 3.8rem;
      text-transform: capitalize;
      visibility: hidden;
    }

    .image-box {
      width: 100%;
      height: 55vh;
      background: #000;
      border-radius: 16px;
      overflow: hidden;
      display: flex;
      align-items: center;
      justify-content: center;
      border: 1px solid var(--border);
      position: relative;
    }

    .reveal-svg {
      width: 100%;
      height: 100%;
      display: block;
      opacity: 0;                 /* prevents any flash */
      transition: opacity 0.25s ease-in;
    }

    .ui-top {
      width: 100%;
      display: flex;
      justify-content: space-between;
      margin-bottom: 15px;
      font-weight: 600;
    }

    .controls { margin-top: 30px; display: flex; gap: 20px; justify-content: center; }

    button {
      padding: 16px 45px;
      font-size: 1.1rem;
      font-weight: 700;
      border: none;
      border-radius: 12px;
      cursor: pointer;
      transition: all 0.2s;
    }
    .btn-primary { background: var(--primary); color: white; }
    .btn-success { background: var(--success); color: white; }
    button:hover { transform: translateY(-2px); filter: brightness(1.2); }

    .home-link{
      position: fixed;
      top: 18px;
      left: 18px;
      z-index: 9999;
      color: var(--text);
      text-decoration: none;
      font-weight: 700;
      font-size: 0.95rem;
      padding: 10px 12px;
      border-radius: 12px;
      border: 1px solid var(--border);
      background: rgba(8,8,8,0.85);
      backdrop-filter: blur(6px);
    }
    .home-link:hover{ filter: brightness(1.2); transform: translateY(-1px); }
  </style>
</head>

<body>
  <a class="home-link" href="index.html">← Home</a>

  <div id="setup-area" class="screen" style="display:flex;">
    <h1 style="margin-top:0;">Activity Setup</h1>
    <p>Enter the Quiz Topic</p>
    <input type="text" id="topicInput" placeholder="e.g. Movie Quiz" />

    <p>Select Quiz Source</p>
    <select id="quizSelect">
      <option value="upload">Upload images (from your device)</option>
      <option value="pr_quiz1">Pre-loaded quiz 1</option>
      <option value="pr_quiz2">Pre-loaded quiz 2</option>
    </select>
    <div id="quizSourceHint" class="hint"></div>

    <p id="uploadLabel">Select Images</p>
    <input type="file" id="imageInput" multiple accept="image/*" />
    <br />
    <button class="btn-primary" onclick="showCoverPage()">Generate Quiz</button>
  </div>

  <div id="cover-page" class="screen">
    <h1 id="displayTopic" style="font-size: 4rem; margin-bottom: 0;">QUIZ TOPIC</h1>
    <h3 style="margin-top: 5px; opacity: 0.7; text-transform: uppercase;">How to play</h3>
    <div class="instruction-container">
      <ul class="instruction-list">
          <li>A highly blurred image will be displayed at first</li>
          <li>Use the <b>Chat</b> or <b>Audio</b> to guess what the image is</li>
          <li>Each click reveals more detail (4 stages total)</li>
          <li>The final click reveals the clear image and the answer</li>
      </ul>
    </div>
    <div class="controls">
      <button class="btn-success" onclick="startGame()">Start Session →</button>
    </div>
  </div>

  <div id="game-container" class="screen">
    <div id="answerDisplay">The Answer</div>

    <div class="ui-top">
      <span id="imgCounter">Challenge 1</span>
      <span style="border: 1px solid white; padding: 4px 15px; border-radius: 20px;" id="blurLabel">Blur: 15%</span>
    </div>

    <div class="image-box" id="imageBox"></div>

    <div class="controls">
      <button id="revealBtn" class="btn-primary" onclick="stepReveal()">Reveal Next Step</button>
      <button id="nextBtn" class="btn-success" onclick="nextImg()" style="display:none;">Next Image →</button>
    </div>
  </div>

  <script>
    // -------------------------
    // Game state
    // -------------------------
    let fileObjs = [];
    let curIdx = 0;
    let curStep = 0;
    let curObjectUrl = null;

    // Reveal design
    const GRID = 10; // 10x10 => 100 blocks
    const TOTAL_BLOCKS = GRID * GRID;

    // -------------------------
    // Pre-loaded quiz sets (GitHub Pages)
    // -------------------------
    // Folder structure:
    //   quizzes/pixel-reveal/pr_quiz1/<your images>
    //   quizzes/pixel-reveal/pr_quiz2/<your images>
    //
    // Filenames are used as answers (underscores/dashes become spaces).
    // Spaces in filenames are supported.
    const PRELOADED_QUIZZES = {
      pr_quiz1: {
        label: "Pre-loaded quiz 1",
        basePath: "./quizzes/pixel-reveal/pr_quiz1/"
      },
      pr_quiz2: {
        label: "Pre-loaded quiz 2",
        basePath: "./quizzes/pixel-reveal/pr_quiz2/"
      }
    };

    // For GitHub Pages: auto-discover images in a folder using the GitHub REST API (public repos).
    function encodePathSegments(path) {
      return String(path || "")
        .split("/")
        .filter(Boolean)
        .map(encodeURIComponent)
        .join("/");
    }

    function inferGithubRepoFromLocation() {
      const host = window.location.hostname || "";
      if (!host.endsWith("github.io")) return null;

      const owner = host.split(".")[0] || "";
      const seg = (window.location.pathname || "").split("/").filter(Boolean);

      // Project pages: https://<owner>.github.io/<repo>/
      // User pages:    https://<owner>.github.io/  (repo is <owner>.github.io)
      const repo = seg.length > 0 ? seg[0] : `${owner}.github.io`;

      if (!owner || !repo) return null;
      return { owner, repo };
    }

    async function listGithubDir(dirPathInRepo) {
      const gh = inferGithubRepoFromLocation();
      if (!gh) {
        throw new Error("Pre-loaded quizzes need GitHub Pages on a *.github.io domain (or a similar host).");
      }

      const apiUrl = `https://api.github.com/repos/${gh.owner}/${gh.repo}/contents/${encodePathSegments(dirPathInRepo)}`;
      const res = await fetch(apiUrl, { headers: { "Accept": "application/vnd.github+json" } });

      if (!res.ok) {
        throw new Error(`Could not list pre-loaded quiz folder via GitHub API (HTTP ${res.status}).`);
      }

      const data = await res.json();
      if (!Array.isArray(data)) {
        throw new Error("Unexpected response when listing pre-loaded quiz folder.");
      }
      return data;
    }

    function isImageFilename(name) {
      return /\.(png|jpe?g|webp|gif)$/i.test(name || "");
    }

    function joinBaseAndFile(basePath, filename) {
      // Encode just the filename portion (supports spaces and special chars)
      return String(basePath || "") + encodeURIComponent(String(filename || ""));
    }

    async function buildPreloadedFileObjs(sourceKey) {
      const quiz = PRELOADED_QUIZZES[sourceKey];
      if (!quiz) throw new Error("Unknown pre-loaded quiz selection.");

      // "./quizzes/pixel-reveal/pr_quiz1/" -> "quizzes/pixel-reveal/pr_quiz1"
      const dir = String(quiz.basePath || "")
        .replace(/^\.\//, "")
        .replace(/\/$/, "");

      const items = await listGithubDir(dir);

      const filenames = items
        .filter(it => it && it.type === "file" && isImageFilename(it.name))
        .map(it => it.name);

      if (filenames.length === 0) {
        throw new Error("No images found in the selected pre-loaded quiz folder.");
      }

      filenames.sort((a, b) => a.localeCompare(b, undefined, { numeric: true, sensitivity: "base" }));

      return filenames.map(fn => ({
        kind: "url",
        url: joinBaseAndFile(quiz.basePath, fn),
        name: fn // IMPORTANT: keep original filename (including spaces) for answer + seed
      }));
    }

    // -------------------------
    // Filename / answer helpers
    // -------------------------
    function filenameFromUrl(url) {
      const clean = (url || "").split("?")[0].split("#")[0];
      const parts = clean.split("/");
      const last = parts[parts.length - 1] || "";
      // Decode %20 etc back to real characters (supports spaces in filenames)
      try { return decodeURIComponent(last); } catch { return last; }
    }

    function displayNameFromFilename(filename) {
      return String(filename || "")
        .split(".")
        .slice(0, -1)
        .join(".")
        .replace(/[_-]/g, " ");
    }

    function getItemFilename(item) {
      if (!item) return "";

      if (item.kind === "file" && item.file) return item.file.name || "";

      if (item.kind === "url") {
        // Prefer raw name returned by GitHub API (keeps spaces exactly)
        if (item.name) return item.name;
        if (item.url) return filenameFromUrl(item.url);
      }

      return item.name || "";
    }

    // -------------------------
    // UI helpers
    // -------------------------
    function updateQuizSourceUi() {
      const sel = document.getElementById("quizSelect");
      const uploadLabel = document.getElementById("uploadLabel");
      const uploadInput = document.getElementById("imageInput");
      const hint = document.getElementById("quizSourceHint");

      if (!sel || !uploadLabel || !uploadInput || !hint) return;

      if (sel.value === "upload") {
        uploadLabel.style.display = "block";
        uploadInput.style.display = "block";
        hint.textContent = "Upload images from your device.";
      } else {
        uploadLabel.style.display = "none";
        uploadInput.style.display = "none";
        const quiz = PRELOADED_QUIZZES[sel.value];
        hint.textContent = quiz
          ? `Using ${quiz.label} (auto-loading images from repo folder).`
          : "Using a pre-loaded quiz set.";
      }
    }

    document.addEventListener("DOMContentLoaded", () => {
      const sel = document.getElementById("quizSelect");
      if (sel) sel.addEventListener("change", updateQuizSourceUi);
      updateQuizSourceUi();
    });

    // ✅ Keep your stage %s; blur strength will be derived using your original px logic
    const STAGES = [
      { blurPercent: 40, revealCount: 0,   showAnswer: false }, // Stage 1
      { blurPercent: 20, revealCount: 20,  showAnswer: false }, // Stage 2
      { blurPercent: 15, revealCount: 50,  showAnswer: false }, // Stage 3
      { blurPercent: 0,  revealCount: 100, showAnswer: true  }  // Stage 4
    ];

    let tileOrder = []; // shuffled block indices per image

    // -------------------------
    // UI flow
    // -------------------------
    async function showCoverPage() {
      const source = document.getElementById('quizSelect').value;
      const input = document.getElementById('imageInput');
      const topic = document.getElementById('topicInput').value;

      try {
        if (source === 'upload') {
          if (input.files.length === 0) return alert("Please select images.");
          fileObjs = Array.from(input.files).map(f => ({
            kind: 'file',
            file: f,
            name: f.name
          }));
        } else {
          fileObjs = await buildPreloadedFileObjs(source);
        }

        if (fileObjs.length === 0) return alert("No images found for this quiz.");

        curIdx = 0;

        document.getElementById('displayTopic').innerText = topic || "The Pixel Reveal";
        document.getElementById('setup-area').style.display = 'none';
        document.getElementById('cover-page').style.display = 'flex';
      } catch (err) {
        alert(err && err.message ? err.message : String(err));
      }
    }

    function startGame() {
      document.getElementById('cover-page').style.display = 'none';
      document.getElementById('game-container').style.display = 'flex';
      loadLevel();
    }

    // -------------------------
    // ✅ Blur logic aligned to your original file
    // Original feel: 15% ≈ 12px, 5% ≈ 4px, 0% = 0px (linear mapping)
    // -------------------------
    function percentToBlurPx(pct) {
      // 15% -> 12px, so px = pct * (12/15) = pct * 0.8
      return Math.max(0, pct * 0.8);
    }

    // Ensure filter region is large enough so blur doesn't get clipped at edges
    function setFilterRegion(filterEl, w, h, blurPx) {
      const pad = Math.max(40, blurPx * 6);
      filterEl.setAttribute("filterUnits", "userSpaceOnUse");
      filterEl.setAttribute("x", String(-pad));
      filterEl.setAttribute("y", String(-pad));
      filterEl.setAttribute("width", String(w + pad * 2));
      filterEl.setAttribute("height", String(h + pad * 2));
    }

    // -------------------------
    // Core: build SVG layers (blur + clear with mask)
    // -------------------------
    function buildRevealSvg(w, h) {
      const svg = document.createElementNS("http://www.w3.org/2000/svg", "svg");
      svg.setAttribute("class", "reveal-svg");

      // ✅ Make SVG units = pixels so blur stdDeviation behaves like CSS px blur
      svg.setAttribute("viewBox", `0 0 ${w} ${h}`);
      svg.setAttribute("preserveAspectRatio", "xMidYMid meet");

      const defs = document.createElementNS(svg.namespaceURI, "defs");

      const filter = document.createElementNS(svg.namespaceURI, "filter");
      filter.setAttribute("id", "blurFilter");

      const feBlur = document.createElementNS(svg.namespaceURI, "feGaussianBlur");
      feBlur.setAttribute("id", "blurNode");
      feBlur.setAttribute("in", "SourceGraphic");
      feBlur.setAttribute("stdDeviation", "0");
      feBlur.setAttribute("edgeMode", "duplicate");

      filter.appendChild(feBlur);
      defs.appendChild(filter);

      const mask = document.createElementNS(svg.namespaceURI, "mask");
      mask.setAttribute("id", "revealMask");

      const maskBg = document.createElementNS(svg.namespaceURI, "rect");
      maskBg.setAttribute("id", "maskBg");
      maskBg.setAttribute("x", "0");
      maskBg.setAttribute("y", "0");
      maskBg.setAttribute("width", String(w));
      maskBg.setAttribute("height", String(h));
      maskBg.setAttribute("fill", "black");

      const maskGroup = document.createElementNS(svg.namespaceURI, "g");
      maskGroup.setAttribute("id", "maskRects");

      mask.appendChild(maskBg);
      mask.appendChild(maskGroup);
      defs.appendChild(mask);

      svg.appendChild(defs);

      const imgBlur = document.createElementNS(svg.namespaceURI, "image");
      imgBlur.setAttribute("id", "imgBlur");
      imgBlur.setAttribute("x", "0");
      imgBlur.setAttribute("y", "0");
      imgBlur.setAttribute("width", String(w));
      imgBlur.setAttribute("height", String(h));
      imgBlur.setAttribute("preserveAspectRatio", "xMidYMid meet");
      imgBlur.setAttribute("filter", "url(#blurFilter)");

      const imgClear = document.createElementNS(svg.namespaceURI, "image");
      imgClear.setAttribute("id", "imgClear");
      imgClear.setAttribute("x", "0");
      imgClear.setAttribute("y", "0");
      imgClear.setAttribute("width", String(w));
      imgClear.setAttribute("height", String(h));
      imgClear.setAttribute("preserveAspectRatio", "xMidYMid meet");
      imgClear.setAttribute("mask", "url(#revealMask)");

      svg.appendChild(imgBlur);
      svg.appendChild(imgClear);

      return svg;
    }

    function setSvgImageHref(svg, url) {
      const blur = svg.querySelector("#imgBlur");
      const clear = svg.querySelector("#imgClear");

      blur.setAttribute("href", url);
      clear.setAttribute("href", url);

      blur.setAttributeNS("http://www.w3.org/1999/xlink", "xlink:href", url);
      clear.setAttributeNS("http://www.w3.org/1999/xlink", "xlink:href", url);
    }

    function applyStage(svg, stepIdx) {
      const stage = STAGES[stepIdx];

      // ✅ Blur now uses px-strength derived from your original logic
      const blurPx = percentToBlurPx(stage.blurPercent);
      const blurNode = svg.querySelector("#blurNode");
      blurNode.setAttribute("stdDeviation", String(blurPx));

      // Ensure filter region won’t clip the blur
      const vb = svg.viewBox.baseVal;
      const filterEl = svg.querySelector("#blurFilter");
      setFilterRegion(filterEl, vb.width, vb.height, blurPx);

      // Mask rectangles (clear reveals)
      const maskGroup = svg.querySelector("#maskRects");
      maskGroup.innerHTML = "";

      const revealCount = Math.min(stage.revealCount, TOTAL_BLOCKS);
      const cellW = vb.width / GRID;
      const cellH = vb.height / GRID;

      for (let i = 0; i < revealCount; i++) {
        const idx = tileOrder[i];
        const r = Math.floor(idx / GRID);
        const c = idx % GRID;

        const rect = document.createElementNS(svg.namespaceURI, "rect");
        rect.setAttribute("x", String(c * cellW));
        rect.setAttribute("y", String(r * cellH));
        rect.setAttribute("width", String(cellW));
        rect.setAttribute("height", String(cellH));
        rect.setAttribute("fill", "white");

        maskGroup.appendChild(rect);
      }

      // UI updates
      document.getElementById('blurLabel').innerText = `Blur: ${stage.blurPercent}%`;

      if (stage.showAnswer) {
        document.getElementById('answerDisplay').style.visibility = 'visible';
        document.getElementById('revealBtn').style.display = 'none';
        document.getElementById('nextBtn').style.display = 'block';
      } else {
        document.getElementById('answerDisplay').style.visibility = 'hidden';
        document.getElementById('revealBtn').style.display = 'block';
        document.getElementById('nextBtn').style.display = 'none';
      }
    }

    // -------------------------
    // Deterministic shuffle (stable per filename)
    // -------------------------
    function hashStringToSeed(str) {
      let h = 2166136261;
      for (let i = 0; i < str.length; i++) {
        h ^= str.charCodeAt(i);
        h = Math.imul(h, 16777619);
      }
      return h >>> 0;
    }

    function mulberry32(seed) {
      return function() {
        let t = seed += 0x6D2B79F5;
        t = Math.imul(t ^ (t >>> 15), t | 1);
        t ^= t + Math.imul(t ^ (t >>> 7), t | 61);
        return ((t ^ (t >>> 14)) >>> 0) / 4294967296;
      };
    }

    function makeTileOrder(seedStr) {
      const seed = hashStringToSeed(seedStr);
      const rand = mulberry32(seed);

      const arr = Array.from({ length: TOTAL_BLOCKS }, (_, i) => i);
      for (let i = arr.length - 1; i > 0; i--) {
        const j = Math.floor(rand() * (i + 1));
        [arr[i], arr[j]] = [arr[j], arr[i]];
      }
      return arr;
    }

    // -------------------------
    // Level loading
    // -------------------------
    function loadLevel() {
      curStep = 0;

      const item = fileObjs[curIdx];
      const imageBox = document.getElementById('imageBox');
      const ans = document.getElementById('answerDisplay');

      // Only revoke blob object URLs that we created
      if (curObjectUrl && curObjectUrl.startsWith('blob:')) {
        URL.revokeObjectURL(curObjectUrl);
      }
      curObjectUrl = null;

      const filename = getItemFilename(item);
      const name = displayNameFromFilename(filename);
      ans.innerText = name;
      ans.style.visibility = 'hidden';

      document.getElementById('imgCounter').innerText = `Challenge ${curIdx + 1} of ${fileObjs.length}`;
      tileOrder = makeTileOrder(filename || String(curIdx));

      imageBox.innerHTML = '';

      // ✅ Measure the container in pixels and build SVG in pixel-units
      const rect = imageBox.getBoundingClientRect();
      const w = Math.max(1, Math.floor(rect.width));
      const h = Math.max(1, Math.floor(rect.height));
      const svg = buildRevealSvg(w, h);
      imageBox.appendChild(svg);

      // Determine image source
      let src = '';
      if (item && item.kind === 'file' && item.file) {
        curObjectUrl = URL.createObjectURL(item.file);
        src = curObjectUrl;
      } else if (item && item.kind === 'url' && item.url) {
        src = item.url;
      } else {
        alert("Invalid image item in quiz set.");
        return location.reload();
      }

      const pre = new Image();
      pre.onload = () => {
        setSvgImageHref(svg, src);

        // Apply stage 1 before showing
        applyStage(svg, 0);

        requestAnimationFrame(() => {
          svg.style.opacity = "1";
        });
      };
      pre.onerror = () => {
        alert(`Could not load image: ${filename}

Check that the file exists in your GitHub repo (or re-upload your images).`);
        location.reload();
      };
      pre.src = src;

      document.getElementById('revealBtn').style.display = 'block';
      document.getElementById('nextBtn').style.display = 'none';
      document.getElementById('blurLabel').innerText = `Blur: ${STAGES[0].blurPercent}%`;
    }

    function stepReveal() {
      const svg = document.querySelector('#imageBox .reveal-svg');
      if (!svg) return;

      if (curStep < STAGES.length - 1) {
        curStep++;
        applyStage(svg, curStep);
      }
    }

    function nextImg() {
      if (curIdx < fileObjs.length - 1) {
        curIdx++;
        loadLevel();
      } else {
        alert("Quiz Complete! Great job team.");
        location.reload();
      }
    }
  </script>
</body>
</html>
